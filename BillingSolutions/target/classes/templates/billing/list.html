<!--<!DOCTYPE html>-->
<!--<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <title>Bill History</title>-->
<!--     Bootstrap 5 CSS -->
<!--    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">-->
<!--     Font Awesome for Icons -->
<!--    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">-->
<!--    <style>-->
<!--        body {-->
<!--            background-color: #f8f9fa;-->
<!--            padding-top: 70px;-->
<!--        }-->
<!--        .navbar {-->
<!--            box-shadow: 0 2px 4px rgba(0,0,0,.1);-->
<!--        }-->
<!--        .table-card {-->
<!--            margin-top: 2rem;-->
<!--            margin-bottom: 4rem;-->
<!--        }-->
<!--        .user-info .nav-link {-->
<!--            display: flex;-->
<!--            align-items: center;-->
<!--        }-->
<!--        .user-info .fa-user-circle {-->
<!--            font-size: 1.5rem;-->
<!--            margin-right: 0.5rem;-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->

<!--     THE FIX: The full, correct navigation bar has been restored. -->
<!--    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">-->
<!--        <div class="container-fluid">-->
<!--            <a class="navbar-brand fw-bold" th:href="@{/}">-->
<!--                <i class="fas fa-file-invoice-dollar"></i>-->
<!--                BillingSolutions-->
<!--            </a>-->
<!--            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">-->
<!--                <span class="navbar-toggler-icon"></span>-->
<!--            </button>-->
<!--            <div class="collapse navbar-collapse" id="navbarNav">-->
<!--                <ul class="navbar-nav me-auto mb-2 mb-lg-0">-->
<!--                    <li class="nav-item"><a class="nav-link" th:href="@{/customers}"><i class="fas fa-users me-1"></i>Customers</a></li>-->
<!--                    <li class="nav-item" sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_USER')"><a class="nav-link" th:href="@{/vendors}"><i class="fas fa-store me-1"></i>Vendors</a></li>-->
<!--                    <li class="nav-item"><a class="nav-link" th:href="@{/products}"><i class="fas fa-box-open me-1"></i>Products</a></li>-->
<!--                    <li class="nav-item"><a class="nav-link" th:href="@{/billing/create}"><i class="fas fa-plus-circle me-1"></i>Create Bill</a></li>-->
<!--                    <li class="nav-item dropdown" sec:authorize="hasRole('ROLE_ADMIN')">-->
<!--                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user-shield me-1"></i>Admin</a>-->
<!--                        <ul class="dropdown-menu" aria-labelledby="adminDropdown">-->
<!--                            <li><a class="dropdown-item" th:href="@{/admin/dashboard}">Admin Dashboard</a></li>-->
<!--                            <li><a class="dropdown-item" th:href="@{/admin/users}">Manage Users</a></li>-->
<!--                        </ul>-->
<!--                    </li>-->
<!--                </ul>-->
<!--                <ul class="navbar-nav user-info">-->
<!--                    <li class="nav-item"><span class="nav-link"><i class="fas fa-user-circle"></i> <span sec:authentication="name">Username</span></span></li>-->
<!--                    <li class="nav-item"><form th:action="@{/logout}" method="post" class="d-flex"><button class="btn btn-outline-danger btn-sm" type="submit">Logout</button></form></li>-->
<!--                </ul>-->
<!--            </div>-->
<!--        </div>-->
<!--    </nav>-->

<!--     Main Content -->
<!--    <div class="container">-->
<!--        <div class="card table-card">-->
<!--            <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">-->
<!--                <h1 class="h4 mb-0"><i class="fas fa-history me-2"></i>Bill History</h1>-->
<!--                <a th:href="@{/billing/create}" class="btn btn-primary"><i class="fas fa-plus me-1"></i> Create New Bill</a>-->
<!--            </div>-->
<!--            <div class="card-body">-->
<!--                <div class="card mb-4">-->
<!--                    <div class="card-body bg-light">-->
<!--                        <div class="row g-3 align-items-center">-->
<!--                            <div class="col-md-4">-->
<!--                                <label for="financialYear" class="visually-hidden">Financial Year</label>-->
<!--                                <div class="input-group">-->
<!--                                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>-->
<!--                                    <select id="financialYear" name="financialYear" class="form-select">-->
<!--                                        <option value="">All Years</option>-->
<!--                                        <option th:each="year : ${financialYears}" th:value="${year}" th:text="${year}" th:selected="${year == selectedFinancialYear}"></option>-->
<!--                                    </select>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                            <div class="col-md-8">-->
<!--                                <label for="searchInput" class="visually-hidden">Search</label>-->
<!--                                <div class="input-group">-->
<!--                                    <span class="input-group-text"><i class="fas fa-search"></i></span>-->
<!--                                    <input class="form-control" type="search" id="searchInput" name="query" placeholder="Start typing a Bill No. or Customer Name..." th:value="${query}">-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </div>-->

<!--                 Bills Table -->
<!--                <div class="table-responsive">-->
<!--                    <table class="table table-striped table-hover">-->
<!--                        <thead class="table-light">-->
<!--                            <tr>-->
<!--                                <th scope="col">Bill No.</th>-->
<!--                                <th scope="col">Customer</th>-->
<!--                                <th scope="col" id="financial-year-header" th:style="${(selectedFinancialYear != null and !selectedFinancialYear.isEmpty()) ? 'display:none;' : ''}">Financial Year</th>-->
<!--                                <th scope="col">Date</th>-->
<!--                                <th scope="col" class="text-end">Total Amount</th>-->
<!--                                <th scope="col" class="text-end">Actions</th>-->
<!--                            </tr>-->
<!--                        </thead>-->
<!--                        <tbody id="bill-table-body">-->
<!--                            Initial rows are loaded by Thymeleaf -->
<!--                           <tr th:each="bill : ${bills}">-->
<!--                               <td th:text="${bill.billNo}" class="fw-bold"></td>-->
<!--                               <td th:text="${bill.customerNameSnapshot}"></td>-->
<!--                               <td th:if="${selectedFinancialYear == null or selectedFinancialYear.isEmpty()}" th:text="${bill.financialYear}"></td>-->
<!--                               <td th:text="${#temporals.format(bill.createdAt, 'dd-MMM-yyyy')}"></td>-->
<!--                               <td class="text-end" th:text="${'₹' + #numbers.formatDecimal(bill.total, 1, 2, 'POINT')}"></td>-->
<!--                               <td class="text-end">-->
<!--                                   <a th:href="@{'/billing/' + ${bill.id}}" class="btn btn-sm btn-info"><i class="fas fa-eye me-1"></i> View</a>-->
<!--                               </td>-->
<!--                           </tr>-->
<!--                           <tr th:if="${#lists.isEmpty(bills)}">-->
<!--                               <td th:attr="colspan=${(selectedFinancialYear == null or selectedFinancialYear.isEmpty()) ? 6 : 5}" class="text-center text-muted p-4">-->
<!--                                   <p class="mb-1">No bills found for your business.</p>-->
<!--                                   <small>Try creating a new bill to get started.</small>-->
<!--                               </td>-->
<!--                           </tr>-->
<!--                        </tbody>-->
<!--                    </table>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->
    
<!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>-->
    
<!--    <script>-->
<!--        document.addEventListener('DOMContentLoaded', function () {-->
<!--            const searchInput = document.getElementById('searchInput');-->
<!--            const yearSelect = document.getElementById('financialYear');-->
<!--            const tableBody = document.getElementById('bill-table-body');-->
<!--            const financialYearHeader = document.getElementById('financial-year-header');-->
<!--            let debounceTimer;-->

<!--            function createBillRow(bill, showFinancialYear) {-->
<!--                const tr = document.createElement('tr');-->
<!--                const date = new Date(bill.createdAt);-->
<!--                const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-');-->
<!--                const formattedTotal = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(bill.total);-->

<!--                let rowHtml = `-->
<!--                    <td class="fw-bold">${bill.billNo}</td>-->
<!--                    <td>${bill.customerNameSnapshot}</td>-->
<!--                `;-->

<!--                if (showFinancialYear) {-->
<!--                    rowHtml += `<td>${bill.financialYear}</td>`;-->
<!--                }-->

<!--                rowHtml += `-->
<!--                    <td>${formattedDate}</td>-->
<!--                    <td class="text-end">${formattedTotal}</td>-->
<!--                    <td class="text-end">-->
<!--                        <a href="/billing/${bill.id}" class="btn btn-sm btn-info"><i class="fas fa-eye me-1"></i> View</a>-->
<!--                    </td>-->
<!--                `;-->
<!--                tr.innerHTML = rowHtml;-->
<!--                return tr;-->
<!--            }-->

<!--            function createNoResultsRow(showFinancialYear) {-->
<!--                const tr = document.createElement('tr');-->
<!--                const colspan = showFinancialYear ? 6 : 5;-->
<!--                tr.innerHTML = `<td colspan="${colspan}" class="text-center text-muted p-4"><p class="mb-1">No bills found matching your criteria.</p><small>Try adjusting your search or financial year filter.</small></td>`;-->
<!--                return tr;-->
<!--            }-->

<!--            function performSearch() {-->
<!--                clearTimeout(debounceTimer);-->
<!--                debounceTimer = setTimeout(() => {-->
<!--                    const query = searchInput.value;-->
<!--                    const financialYear = yearSelect.value;-->
<!--                    const showFinancialYear = financialYear === '';-->

<!--                    if (financialYearHeader) {-->
<!--                        financialYearHeader.style.display = showFinancialYear ? '' : 'none';-->
<!--                    }-->

<!--                    const searchUrl = new URL('/billing/search', window.location.origin);-->
<!--                    searchUrl.searchParams.append('query', query);-->
<!--                    searchUrl.searchParams.append('financialYear', financialYear);-->

<!--                    fetch(searchUrl)-->
<!--                        .then(response => response.json())-->
<!--                        .then(data => {-->
<!--                            tableBody.innerHTML = '';-->
<!--                            if (data && data.length > 0) {-->
<!--                                data.forEach(bill => {-->
<!--                                    tableBody.appendChild(createBillRow(bill, showFinancialYear));-->
<!--                                });-->
<!--                            } else {-->
<!--                                tableBody.appendChild(createNoResultsRow(showFinancialYear));-->
<!--                            }-->
<!--                        })-->
<!--                        .catch(error => console.error('Error performing search:', error));-->
<!--                }, 300); -->
<!--            }-->

<!--            yearSelect.addEventListener('change', performSearch);-->
<!--            searchInput.addEventListener('keyup', performSearch);-->
<!--        });-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->
<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 70px;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.1);
        }
        .table-card {
            margin-top: 2rem;
            margin-bottom: 4rem;
        }
        .user-info .nav-link {
            display: flex;
            align-items: center;
        }
        .user-info .fa-user-circle {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" th:href="@{/}">
                <i class="fas fa-file-invoice-dollar"></i>
                BillingSolutions
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link" th:href="@{/customers}"><i class="fas fa-users me-1"></i>Customers</a></li>
                    <li class="nav-item" sec:authorize="hasAnyRole('ROLE_ADMIN', 'ROLE_USER')"><a class="nav-link" th:href="@{/vendors}"><i class="fas fa-store me-1"></i>Vendors</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/products}"><i class="fas fa-box-open me-1"></i>Products</a></li>
                    <li class="nav-item"><a class="nav-link" th:href="@{/billing/create}"><i class="fas fa-plus-circle me-1"></i>Create Bill</a></li>
                    <li class="nav-item dropdown" sec:authorize="hasRole('ROLE_ADMIN')">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user-shield me-1"></i>Admin</a>
                        <ul class="dropdown-menu" aria-labelledby="adminDropdown">
                            <li><a class="dropdown-item" th:href="@{/admin/dashboard}">Admin Dashboard</a></li>
                            <li><a class="dropdown-item" th:href="@{/admin/users}">Manage Users</a></li>
                        </ul>
                    </li>
                </ul>
                <ul class="navbar-nav user-info">
                    <li class="nav-item"><span class="nav-link"><i class="fas fa-user-circle"></i> <span sec:authentication="name">Username</span></span></li>
                    <li class="nav-item"><form th:action="@{/logout}" method="post" class="d-flex"><button class="btn btn-outline-danger btn-sm" type="submit">Logout</button></form></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card table-card">
            <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                <h1 class="h4 mb-0"><i class="fas fa-history me-2"></i>Bill History</h1>
                <a th:href="@{/billing/create}" class="btn btn-primary"><i class="fas fa-plus me-1"></i> Create New Bill</a>
            </div>
            <div class="card-body">
                <div class="card mb-4">
                    <div class="card-body bg-light">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-4">
                                <label for="financialYear" class="visually-hidden">Financial Year</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                                    <select id="financialYear" name="financialYear" class="form-select">
                                        <option value="">All Years</option>
                                        <option th:each="year : ${financialYears}" th:value="${year}" th:text="${year}" th:selected="${year == selectedFinancialYear}"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <label for="searchInput" class="visually-hidden">Search</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input class="form-control" type="search" id="searchInput" name="query" placeholder="Start typing a Bill No. or Customer Name..." th:value="${query}">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Bill No.</th>
                                <th scope="col">Customer</th>
                                <th scope="col" id="financial-year-header" th:style="${(selectedFinancialYear != null and !selectedFinancialYear.isEmpty()) ? 'display:none;' : ''}">Financial Year</th>
                                <th scope="col">Date</th>
                                <th scope="col" class="text-end">Total Amount</th>
                                <th scope="col" class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bill-table-body">
                           <tr th:each="bill : ${bills}">
                               <td th:text="${bill.billNo}" class="fw-bold"></td>
                               <td th:text="${bill.customerNameSnapshot}"></td>
                               <td th:if="${selectedFinancialYear == null or selectedFinancialYear.isEmpty()}" th:text="${bill.financialYear}"></td>
                               <td th:text="${#temporals.format(bill.createdAt, 'dd-MMM-yyyy')}"></td>
                               <td class="text-end" th:text="${'₹' + #numbers.formatDecimal(bill.total, 1, 2, 'POINT')}"></td>
                               <td class="text-end">
                                   <a th:href="@{'/billing/' + ${bill.id}}" class="btn btn-sm btn-info" title="View Bill"><i class="fas fa-eye"></i></a>
                                   
                                   <span th:if="${bill.editable}" class="ms-1">
                                       <a th:href="@{'/billing/' + ${bill.id} + '/edit'}" class="btn btn-sm btn-outline-primary" title="Edit Bill"><i class="fas fa-edit"></i></a>
                                       <form th:action="@{'/billing/' + ${bill.id} + '/delete'}" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this bill? This action cannot be undone.');">
                                           <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Bill"><i class="fas fa-trash"></i></button>
                                       </form>
                                   </span>
                               </td>
                           </tr>
                           <tr th:if="${#lists.isEmpty(bills)}">
                               <td th:attr="colspan=${(selectedFinancialYear == null or selectedFinancialYear.isEmpty()) ? 6 : 5}" class="text-center text-muted p-4">
                                   <p class="mb-1">No bills found for your business.</p>
                                   <small>Try creating a new bill to get started.</small>
                               </td>
                           </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            const yearSelect = document.getElementById('financialYear');
            const tableBody = document.getElementById('bill-table-body');
            const financialYearHeader = document.getElementById('financial-year-header');
            let debounceTimer;

            // **FIX**: Updated function to create table rows, now includes conditional Edit/Delete buttons
            function createBillRow(bill, showFinancialYear) {
                const tr = document.createElement('tr');
                const date = new Date(bill.createdAt);
                const formattedDate = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }).replace(/ /g, '-');
                const formattedTotal = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' }).format(bill.total);

                // Conditionally create the edit/delete buttons HTML if the bill is editable
                const actionButtons = bill.editable ? `
                    <span class="ms-1">
                        <a href="/billing/${bill.id}/edit" class="btn btn-sm btn-outline-primary" title="Edit Bill"><i class="fas fa-edit"></i></a>
                        <form action="/billing/${bill.id}/delete" method="post" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this bill? This action cannot be undone.');">
                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete Bill"><i class="fas fa-trash"></i></button>
                        </form>
                    </span>
                ` : '';

                let rowHtml = `
                    <td class="fw-bold">${bill.billNo}</td>
                    <td>${bill.customerNameSnapshot}</td>
                `;

                if (showFinancialYear) {
                    rowHtml += `<td>${bill.financialYear}</td>`;
                }

                rowHtml += `
                    <td>${formattedDate}</td>
                    <td class="text-end">${formattedTotal}</td>
                    <td class="text-end">
                        <a href="/billing/${bill.id}" class="btn btn-sm btn-info" title="View Bill"><i class="fas fa-eye"></i></a>
                        ${actionButtons}
                    </td>
                `;
                tr.innerHTML = rowHtml;
                return tr;
            }

            function createNoResultsRow(showFinancialYear) {
                const tr = document.createElement('tr');
                const colspan = showFinancialYear ? 6 : 5;
                tr.innerHTML = `<td colspan="${colspan}" class="text-center text-muted p-4"><p class="mb-1">No bills found matching your criteria.</p><small>Try adjusting your search or financial year filter.</small></td>`;
                return tr;
            }

            function performSearch() {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = searchInput.value;
                    const financialYear = yearSelect.value;
                    const showFinancialYear = financialYear === '';

                    if (financialYearHeader) {
                        financialYearHeader.style.display = showFinancialYear ? '' : 'none';
                    }

                    const searchUrl = new URL('/billing/search', window.location.origin);
                    searchUrl.searchParams.append('query', query);
                    searchUrl.searchParams.append('financialYear', financialYear);

                    fetch(searchUrl)
                        .then(response => response.json())
                        .then(data => {
                            tableBody.innerHTML = '';
                            if (data && data.length > 0) {
                                data.forEach(bill => {
                                    tableBody.appendChild(createBillRow(bill, showFinancialYear));
                                });
                            } else {
                                tableBody.appendChild(createNoResultsRow(showFinancialYear));
                            }
                        })
                        .catch(error => console.error('Error performing search:', error));
                }, 300); 
            }

            yearSelect.addEventListener('change', performSearch);
            searchInput.addEventListener('keyup', performSearch);
        });
    </script>
</body>
</html>
